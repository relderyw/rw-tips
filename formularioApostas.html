<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulário de Apostas</title>
    <style>
        :root {
            --neon-primary: #0ff;
            --neon-secondary: #f0f;
            --dark-bg: #121212;
            --dark-secondary: #1e1e1e;
            --text-primary: #fff;
            --text-secondary: #888;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: var(--dark-bg);
            color: var(--text-primary);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        h1 {
            color: var(--neon-primary);
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin: 20px 0;
            text-shadow: 0 0 10px var(--neon-primary);
        }

        label {
            color: var(--text-secondary);
            margin-bottom: 5px;
            display: block;
            font-weight: 500;
        }

        select, input {
            width: 100%;
            background-color: var(--dark-secondary);
            border: 1px solid var(--neon-primary);
            color: var(--text-primary);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            outline: none;
            transition: all 0.3s ease;
        }

        select:focus, input:focus {
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.3);
        }

        #salvar-dados {
            background: var(--dark-secondary);
            color: var(--neon-primary);
            border: 2px solid var(--neon-primary);
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            width: 100%;
            font-weight: bold;
            margin-top: 10px;
        }

        #salvar-dados:hover {
            background: var(--neon-primary);
            color: var(--dark-bg);
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.4);
            transform: translateY(-2px);
        }

        .back-button {
            position: absolute;
            top: 20px;
            left: 20px;
            background: transparent;
            border: none;
            color: var(--neon-primary);
            cursor: pointer;
            font-size: 24px;
        }

        .back-button::before {
            content: "←";
            text-shadow: 0 0 10px var(--neon-primary);
        }

        .apostas-lista {
            margin-top: 25px;
            max-height: 300px;
            overflow-y: auto;
            border: 2px solid var(--neon-primary);
            border-radius: 12px;
            padding: 15px;
            background-color: rgba(30, 30, 30, 0.8);
            box-shadow: inset 0 0 20px rgba(0, 255, 255, 0.2);
        }

        .aposta-item {
            background: var(--dark-secondary);
            border: 1px solid var(--neon-primary);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .aposta-item:hover {
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.2);
            transform: translateX(5px);
        }

        .aposta-info {
            flex: 1;
        }

        .aposta-actions button {
            background: var(--dark-secondary);
            color: #ff4060;
            border: 1px solid #ff4060;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .aposta-actions button:hover {
            background: #ff4060;
            color: var(--dark-bg);
            box-shadow: 0 0 15px rgba(255, 64, 96, 0.4);
        }

        .resumo {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 25px;
        }

        .resumo-item {
            background: var(--dark-secondary);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border: 2px solid var(--neon-primary);
            transition: all 0.3s ease;
        }

        .resumo-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.2);
        }

        .resumo-item strong {
            display: block;
            margin-top: 10px;
            font-size: 24px;
        }

        .green {
            color: #0f0;
            text-shadow: 0 0 5px #0f0;
        }

        .red {
            color: #f00;
            text-shadow: 0 0 5px #f00;
        }

        .grafico-container {
            margin-top: 25px;
            padding: 20px;
            background: var(--dark-secondary);
            border: 2px solid var(--neon-primary);
            border-radius: 12px;
            height: 300px;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.2);
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: var(--neon-primary);
            font-style: italic;
        }

        @keyframes dots {
            0%, 20% { content: "."; }
            40% { content: ".."; }
            60%, 100% { content: "..."; }
        }

        .loading::after {
            content: "";
            animation: dots 1.5s infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <button class="back-button" id="voltar-btn"></button>
        <h1>Aposta Moderna</h1>
        
        <label for="data-hora">Data e Hora da Aposta:</label>
        <input type="text" id="data-hora" readonly />
        
        <label for="liga">Liga:</label>
        <select id="liga">
            <option value="Battle 6 min">Battle 6 min</option>
            <option value="Battle 8 min">Battle 8 min</option>
            <option value="Battle 8 min (H2H)">Battle 8 min (H2H)</option>
            <option value="Adriact 10 min">Adriact 10 min</option>
            <option value="GT 12 min">GT 12 min</option>
        </select>

        <label for="jogador1">Jogador 1:</label>
        <select id="jogador1">
            <option value="">Selecione o Jogador 1</option>
        </select>

        <label for="jogador2">Jogador 2:</label>
        <select id="jogador2">
            <option value="">Selecione o Jogador 2</option>
        </select>

        <label for="mercado">Mercado:</label>
        <input type="text" id="mercado" placeholder="Ex: Vitória, Empate" />

        <label for="stake">Stake (R$):</label>
        <input type="text" id="stake" placeholder="Ex: 100,00" />

        <label for="odds">Odds:</label>
        <input type="text" id="odds" placeholder="Ex: 1.65" />

        <label for="resultado">Resultado:</label>
        <select id="resultado">
            <option value="green">Green</option>
            <option value="red">Red</option>
            <option value="meio-green">Meio Green</option>
            <option value="meio-red">Meio Red</option>
            <option value="reembolso">Reembolso</option>
        </select>

        <button id="salvar-dados">Salvar Dados</button>

        <div class="result" id="resultado-final">
            R$ Valor: <span>Calculando...</span>
        </div>

        <div class="resumo">
            <div class="resumo-item green" id="ganho-total">
                Ganho Total
                <strong>R$ 0,00</strong>
            </div>
            <div class="resumo-item red" id="perda-total">
                Perda Total
                <strong>R$ 0,00</strong>
            </div>
            <div class="resumo-item" id="saldo-total">
                Saldo Total
                <strong>R$ 0,00</strong>
            </div>
        </div>

        <div class="grafico-container" id="grafico">
            <div class="loading">Carregando gráfico</div>
        </div>

        <h3 style="margin-top: 25px; color: var(--neon-primary)">Histórico de Apostas</h3>
        <div class="apostas-lista" id="apostas-lista">
            <div class="loading">Carregando apostas</div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-app.js";
        import {
            getFirestore,
            collection,
            addDoc,
            deleteDoc,
            doc,
            onSnapshot,
            serverTimestamp,
            query,
            where,
            orderBy,
            getDocs,
        } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyALiAKWq7Z6B9ut6KCHt9L4g8Vt8VHF6iM",
            authDomain: "rw-tips.firebaseapp.com",
            projectId: "rw-tips",
            storageBucket: "rw-tips.appspot.com",
            messagingSenderId: "806941219354",
            appId: "1:806941219354:web:6f904532b6884251444fa3",
            measurementId: "G-64HF8TWQV4",
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Funções auxiliares
        function formatarMoeda(valor) {
            return valor.toLocaleString('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            });
        }

        function getStatusClass(resultado) {
            const classes = {
                'green': 'green',
                'red': 'red',
                'meio-green': 'green',
                'meio-red': 'red',
                'reembolso': 'gray'
            };
            return classes[resultado] || '';
        }

        function getStatusText(resultado) {
            const textos = {
                'green': 'Green',
                'red': 'Red',
                'meio-green': 'Meio Green',
                'meio-red': 'Meio Red',
                'reembolso': 'Reembolso'
            };
            return textos[resultado] || resultado;
        }

        // Função para buscar jogadores da API
        async function buscarJogadores() {
            const ligaSelecionada = document.getElementById("liga").value;
            
            const ligaMapping = {
                "Battle 6 min": "Esoccer Battle Volta - 6 mins play",
                "Battle 8 min": "Esoccer Battle - 8 mins play",
                "Battle 8 min (H2H)": "Esoccer H2H GG League - 8 mins play",
                "Adriact 10 min": "Esoccer Adriatic League - 10 mins play",
                "GT 12 min": "Esoccer GT Leagues – 12 mins play"
            };

            try {
                const response = await fetch("https://api.green365.com.br/api/league/upcoming?sport=fifa&leagueId=&page=1");
                const data = await response.json();
                
                const jogadores = new Set();
                data.data.forEach(jogo => {
                    if (jogo.leagueName === ligaMapping[ligaSelecionada]) {
                        const homePlayer = jogo.home.match(/\(([^)]+)\)/)?.[1] || jogo.home;
                        const awayPlayer = jogo.away.match(/\(([^)]+)\)/)?.[1] || jogo.away;
                        jogadores.add(homePlayer);
                        jogadores.add(awayPlayer);
                    }
                });

                const jogadoresArray = Array.from(jogadores).sort();

                const jogador1El = document.getElementById("jogador1");
                const jogador2El = document.getElementById("jogador2");

                jogador1El.innerHTML = '<option value="">Selecione o Jogador 1</option>';
                jogador2El.innerHTML = '<option value="">Selecione o Jogador 2</option>';

                jogadoresArray.forEach(jogador => {
                    jogador1El.innerHTML += `<option value="${jogador}">${jogador}</option>`;
                    jogador2El.innerHTML += `<option value="${jogador}">${jogador}</option>`;
                });
            } catch (error) {
                console.error("Erro ao buscar jogadores:", error);
                alert("Erro ao carregar jogadores. Por favor, tente novamente.");
            }
        }

        // Função para calcular valor
        function calcularValor() {
            const stake = parseFloat(document.getElementById("stake").value.replace(/[^\d.,]/g, "").replace(",", "."));
            const odds = parseFloat(document.getElementById("odds").value.replace(",", "."));
            const resultado = document.getElementById("resultado").value;

            let valorFinal = 0;

            if (isNaN(stake) || isNaN(odds)) {
                document.getElementById("resultado-final").innerHTML = `R$ Valor: <span>Valores inválidos</span>`;
                return;
            }

            switch (resultado) {
                case "green":
                    valorFinal = stake * (odds - 1);
                    break;
                case "red":
                    valorFinal = -stake;
                    break;
                case "meio-green":
                    valorFinal = (stake / 2) * (odds - 1);
                    break;
                case "meio-red":
                    valorFinal = -stake / 2;
                    break;
                case "reembolso":
                    valorFinal = 0;
                    break;
            }

            document.getElementById("resultado-final").innerHTML = `R$ Valor: <span>${formatarMoeda(valorFinal)}</span>`;
        }

        // Função para atualizar data e hora
        function atualizarDataHora() {
            const agora = new Date();
            const options = { dateStyle: "short", timeStyle: "medium" };
            document.getElementById("data-hora").value = agora.toLocaleString("pt-BR", options);
        }

        // Função para limpar campos
        function limparCampos() {
            document.getElementById("jogador1").value = "";
            document.getElementById("jogador2").value = "";
            document.getElementById("mercado").value = "";
            document.getElementById("stake").value = "";
            document.getElementById("odds").value = "";
            document.getElementById("resultado").value = "green";
            atualizarDataHora();
            calcularValor();
        }

        // Função para criar gráfico
        async function criarGrafico() {
            const datas = [];
            for (let i = 6; i >= 0; i--) {
                const data = new Date();
                data.setDate(data.getDate() - i);
                datas.push(data);
            }

            const apostasQuery = query(collection(db, "apostas"), orderBy("timestamp", "asc"));
            const snapshot = await getDocs(apostasQuery);
            const todasApostas = [];
            
            snapshot.forEach((doc) => {
                const data = doc.data();
                todasApostas.push({
                    ...data,
                    id: doc.id,
                    timestamp: data.timestamp?.toDate() || new Date(),
                });
            });

            const saldosDiarios = datas.map((data) => {
                const dataStr = data.toLocaleDateString("pt-BR");
                const inicioDoDia = new Date(data.setHours(0, 0, 0, 0));
                const fimDoDia = new Date(data.setHours(23, 59, 59, 999));

                const apostasDoDia = todasApostas.filter((aposta) => {
                    return aposta.timestamp >= inicioDoDia && aposta.timestamp <= fimDoDia;
                });

                let saldoDia = 0;
                apostasDoDia.forEach((aposta) => {
                    const stake = parseFloat(
                        aposta.stake.replace(/[^\d.,]/g, "").replace(",", ".")
                    );
                    const odds = parseFloat(aposta.odds.replace(",", "."));

                    switch (aposta.resultado) {
                        case "green":
                            saldoDia += stake * (odds - 1);
                            break;
                        case "red":
                            saldoDia -= stake;
                            break;
                        case "meio-green":
                            saldoDia += (stake / 2) * (odds - 1);
                            break;
                        case "meio-red":
                            saldoDia -= stake / 2;
                            break;
                    }
                });

                return {
                    data: dataStr,
                    saldo: saldoDia,
                };
            });

            const ctx = document.getElementById("grafico");
            if (window.myChart) {
                window.myChart.destroy();
            }

            window.myChart = new Chart(ctx, {
                type: "line",
                data: {
                    labels: saldosDiarios.map((item) => item.data),
                    datasets: [
                        {
                            label: "Saldo Diário",
                            data: saldosDiarios.map((item) => item.saldo),
                            borderColor: "#0ff",
                            backgroundColor: "rgba(0, 255, 255, 0.1)",
                            tension: 0.4,
                            fill: true,
                        },
                    ],
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: "#e0e0e0",
                            },
                        },
                    },
                    scales: {
                        y: {
                            grid: {
                                color: "rgba(255, 255, 255, 0.1)",
                            },
                            ticks: {
                                color: "#e0e0e0",
                            },
                        },
                        x: {
                            grid: {
                                color: "rgba(255, 255, 255, 0.1)",
                            },
                            ticks: {
                                color: "#e0e0e0",
                            },
                        },
                    },
                },
            });
        }

        // Função para carregar apostas
        function carregarApostas() {
            const apostasLista = document.getElementById("apostas-lista");
            apostasLista.innerHTML = '<div class="loading">Carregando apostas</div>';

            const hoje = new Date();
            const inicioDoDia = new Date(hoje.setHours(0, 0, 0, 0));
            const fimDoDia = new Date(hoje.setHours(23, 59, 59, 999));

            const apostasRef = query(
                collection(db, "apostas"),
                where("timestamp", ">", inicioDoDia),
                where("timestamp", "<", fimDoDia),
                orderBy("timestamp", "desc")
            );

            onSnapshot(apostasRef, (snapshot) => {
                let ganhoTotal = 0;
                let perdaTotal = 0;
                let todasApostas = [];

                if (snapshot.empty) {
                    apostasLista.innerHTML = '<div style="text-align: center; padding: 15px; color: #888;">Nenhuma aposta registrada hoje</div>';
                    document.getElementById("grafico").innerHTML = '<div style="text-align: center; padding: 15px; color: #888;">Sem dados para exibir</div>';
                    return;
                }

                apostasLista.innerHTML = "";

                snapshot.forEach((doc) => {
                    const aposta = doc.data();
                    todasApostas.push({ ...aposta, id: doc.id });

                    const stake = parseFloat(aposta.stake.replace(/[^\d.,]/g, "").replace(",", "."));
                    const odds = parseFloat(aposta.odds.replace(",", "."));
                    let valorFinal = 0;

                    switch (aposta.resultado) {
                        case "green":
                            valorFinal = stake * (odds - 1);
                            ganhoTotal += valorFinal;
                            break;
                        case "red":
                            valorFinal = -stake;
                            perdaTotal += stake;
                            break;
                        case "meio-green":
                            valorFinal = (stake / 2) * (odds - 1);
                            ganhoTotal += valorFinal;
                            break;
                        case "meio-red":
                            valorFinal = -stake / 2;
                            perdaTotal += stake / 2;
                            break;
                    }

                    const statusClass = getStatusClass(aposta.resultado);
                    const statusText = getStatusText(aposta.resultado);
                    const valorFinalText = valorFinal === 0 ? "" : ` (${formatarMoeda(valorFinal)})`;

                    const apostaItem = document.createElement("div");
                    apostaItem.classList.add("aposta-item");
                    apostaItem.innerHTML = `
                        <div class="aposta-info">
                            <strong>${aposta.liga}</strong> · <span class="${statusClass}">${statusText}${valorFinalText}</span><br>
                            ${aposta.jogador1} vs ${aposta.jogador2}<br>
                            <small>${aposta.mercado} · Stake: ${formatarMoeda(stake)} · Odds: ${odds}</small>
                        </div>
                        <div class="aposta-actions">
                            <button onclick="removerAposta('${doc.id}')">Remover</button>
                        </div>
                    `;
                    apostasLista.appendChild(apostaItem);
                });

                document.getElementById("ganho-total").innerHTML = `Ganho Total<strong>${formatarMoeda(ganhoTotal)}</strong>`;
                document.getElementById("perda-total").innerHTML = `Perda Total<strong>${formatarMoeda(perdaTotal)}</strong>`;
                document.getElementById("saldo-total").innerHTML = `Saldo Total<strong>${formatarMoeda(ganhoTotal - perdaTotal)}</strong>`;

                criarGrafico();
            });
        }

        // Event Listeners
        document.getElementById("liga").addEventListener("change", buscarJogadores);
        document.getElementById("stake").addEventListener("input", calcularValor);
        document.getElementById("odds").addEventListener("input", calcularValor);
        document.getElementById("resultado").addEventListener("change", calcularValor);
        document.getElementById("voltar-btn").addEventListener("click", () => window.location.href = "visualization.html");

        document.getElementById("salvar-dados").addEventListener("click", async () => {
            const dataHora = document.getElementById("data-hora").value;
            const liga = document.getElementById("liga").value;
            const jogador1 = document.getElementById("jogador1").value;
            const jogador2 = document.getElementById("jogador2").value;
            const mercado = document.getElementById("mercado").value;
            const stake = document.getElementById("stake").value;
            const odds = document.getElementById("odds").value;
            const resultado = document.getElementById("resultado").value;

            if (!jogador1 || !jogador2 || !stake || !odds) {
                alert("Preencha todos os campos obrigatórios!");
                return;
            }

            try {
                await addDoc(collection(db, "apostas"), {
                    dataHora,
                    liga,
                    jogador1,
                    jogador2,
                    mercado: mercado || "Vitória",
                    stake: stake.includes("R$") ? stake : `R$ ${stake}`,
                    odds,
                    resultado,
                    timestamp: serverTimestamp(),
                });
                alert("Aposta registrada com sucesso!");
                limparCampos();
            } catch (error) {
                console.error("Erro ao salvar os dados: ", error);
                alert("Ocorreu um erro ao salvar os dados: " + error.message);
            }
        });

        // Função global para remover aposta
        window.removerAposta = async function (id) {
            try {
                await deleteDoc(doc(db, "apostas", id));
                console.log("Aposta removida com sucesso!");
            } catch (error) {
                console.error("Erro ao remover aposta:", error);
                alert("Ocorreu um erro ao remover a aposta: " + error.message);
            }
        };

        // Inicialização
        window.onload = () => {
            atualizarDataHora();
            calcularValor();
            carregarApostas();
            buscarJogadores();
        };
    </script>
</body>
</html>
