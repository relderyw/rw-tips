<!doctype html>

<html lang="pt-br">

<head>

  <meta charset="UTF-8" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>Registrar Aposta</title>

  <style>
    /* Estilo Geral */

    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background-color: #0a0a0d;
      color: #e0e0e0;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      overflow-x: hidden;
      background-image: linear-gradient(to bottom, #0a0a0d, #101022);
    }

    .container {
      background: linear-gradient(145deg, #151522, #0c0c14);
      padding: 30px;
      border-radius: 15px;
      box-shadow:
        0 8px 32px rgba(0, 0, 0, 0.7),
        0 0 15px rgba(187, 134, 252, 0.2),
        0 0 30px rgba(187, 134, 252, 0.1);
      width: 100%;
      max-width: 450px;
      transition: all 0.3s ease-in-out;
      position: relative;
      overflow-y: auto;
      max-height: 90vh;
      margin: 20px 0;
      border: 1px solid rgba(187, 134, 252, 0.1);
    }

    .container:hover {
      transform: scale(1.02);
      box-shadow:
        0 12px 40px rgba(0, 0, 0, 0.8),
        0 0 20px rgba(187, 134, 252, 0.3),
        0 0 40px rgba(187, 134, 252, 0.15);
    }

    h1 {
      text-align: center;
      color: #bb86fc;
      font-size: 28px;
      margin-bottom: 25px;
      letter-spacing: 2px;
      text-shadow:
        0 0 10px rgba(187, 134, 252, 0.8),
        0 0 20px rgba(187, 134, 252, 0.4);
      font-weight: 800;
      text-transform: uppercase;
    }

    label {
      display: block;
      margin-top: 15px;
      font-weight: bold;
      color: #bb86fc;
      font-size: 14px;
      transition: color 0.3s ease;
      margin-bottom: 5px;
      letter-spacing: 1px;
      text-shadow: 0 0 5px rgba(187, 134, 252, 0.3);
    }

    input,
    select {
      width: 100%;
      padding: 12px;
      margin-top: 5px;
      border: 2px solid #333;
      border-radius: 8px;
      background-color: rgba(44, 44, 55, 0.7);
      color: #e0e0e0;
      font-size: 14px;
      transition: all 0.3s ease;
      box-sizing: border-box;
      box-shadow: 0 0 5px rgba(187, 134, 252, 0.1);
    }

    input:focus,
    select:focus {
      background-color: rgba(58, 58, 72, 0.9);
      border-color: #bb86fc;
      transform: scale(1.02);
      outline: none;
      box-shadow:
        0 0 10px rgba(187, 134, 252, 0.5),
        0 0 15px rgba(187, 134, 252, 0.2);
    }

    .result {
      margin-top: 25px;
      font-size: 18px;
      text-align: center;
      color: #bb86fc;
      font-weight: bold;
      animation: glowPulse 3s infinite;
      padding: 20px;
      border-radius: 12px;
      background-color: rgba(187, 134, 252, 0.1);
      border: 1px solid rgba(187, 134, 252, 0.3);
      box-shadow: 0 0 15px rgba(187, 134, 252, 0.2);
    }

    @keyframes glowPulse {
      0% {
        box-shadow: 0 0 10px rgba(187, 134, 252, 0.3);
      }

      50% {
        box-shadow: 0 0 20px rgba(187, 134, 252, 0.5);
      }

      100% {
        box-shadow: 0 0 10px rgba(187, 134, 252, 0.3);
      }
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    .result span {
      display: block;
      margin-top: 10px;
      font-size: 28px;
      color: #03dac6;
      text-shadow:
        0 0 10px rgba(3, 218, 198, 0.8),
        0 0 20px rgba(3, 218, 198, 0.4);
    }

    /* Botão Voltar */
    .back-button {
      position: absolute;
      top: 15px;
      left: 15px;
      background: linear-gradient(145deg, #bb86fc, #9c27b0);
      color: #121212;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      font-size: 18px;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      box-shadow:
        0 4px 10px rgba(0, 0, 0, 0.5),
        0 0 10px rgba(187, 134, 252, 0.5);
      transition: all 0.3s ease;
      z-index: 10;
    }

    .back-button:hover {
      background: linear-gradient(145deg, #9c27b0, #bb86fc);
      transform: scale(1.1);
      box-shadow:
        0 6px 12px rgba(0, 0, 0, 0.6),
        0 0 15px rgba(187, 134, 252, 0.6);
    }

    /* Ícone de Voltar */
    .back-button::before {
      content: "←";
      font-weight: bold;
    }

    /* Botão Salvar Dados */
    #salvar-dados {
      width: 100%;
      padding: 14px;
      margin-top: 25px;
      border: none;
      border-radius: 10px;
      background: linear-gradient(145deg, #bb86fc, #9c27b0);
      color: #121212;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow:
        0 4px 10px rgba(0, 0, 0, 0.3),
        0 0 10px rgba(187, 134, 252, 0.3);
      letter-spacing: 1px;
      text-transform: uppercase;
    }

    #salvar-dados:hover {
      background: linear-gradient(145deg, #9c27b0, #bb86fc);
      transform: scale(1.03);
      box-shadow:
        0 6px 15px rgba(0, 0, 0, 0.4),
        0 0 20px rgba(187, 134, 252, 0.5);
    }

    /* Lista de Apostas */
    .apostas-lista {
      margin-top: 25px;
      max-height: 200px;
      overflow-y: auto;
      border: 2px solid rgba(187, 134, 252, 0.3);
      border-radius: 10px;
      padding: 15px;
      background-color: rgba(30, 30, 40, 0.7);
      box-shadow:
        inset 0 0 10px rgba(0, 0, 0, 0.5),
        0 0 10px rgba(187, 134, 252, 0.2);
    }

    .apostas-lista::-webkit-scrollbar {
      width: 8px;
    }

    .apostas-lista::-webkit-scrollbar-track {
      background: #1a1a2a;
      border-radius: 10px;
    }

    .apostas-lista::-webkit-scrollbar-thumb {
      background: linear-gradient(to bottom, #bb86fc, #9c27b0);
      border-radius: 10px;
    }

    .aposta-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      border-bottom: 1px solid rgba(187, 134, 252, 0.2);
      transition: all 0.3s ease;
      border-radius: 8px;
      margin-bottom: 8px;
      background-color: rgba(40, 40, 50, 0.3);
    }

    .aposta-item:hover {
      background-color: rgba(60, 60, 80, 0.3);
      transform: translateX(5px);
      box-shadow: 0 0 10px rgba(187, 134, 252, 0.2);
    }

    .aposta-item:last-child {
      border-bottom: none;
      margin-bottom: 0;
    }

    .aposta-info {
      flex: 1;
      line-height: 1.5;
    }

    .aposta-actions button {
      background: linear-gradient(145deg, #cf6679, #ff4060);
      color: #121212;
      border: none;
      border-radius: 5px;
      padding: 8px 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: bold;
      margin-left: 10px;
      box-shadow: 0 0 10px rgba(207, 102, 121, 0.3);
    }

    .aposta-actions button:hover {
      background: linear-gradient(145deg, #ff4060, #cf6679);
      transform: scale(1.05);
      box-shadow: 0 0 15px rgba(207, 102, 121, 0.5);
    }

    /* Resumo de Ganhos/Perdas */
    .resumo {
      margin-top: 25px;
      padding: 20px;
      background: linear-gradient(145deg, #1e1e2d, #12121e);
      border-radius: 12px;
      box-shadow:
        0 4px 15px rgba(0, 0, 0, 0.5),
        0 0 15px rgba(187, 134, 252, 0.1);
      display: flex;
      justify-content: space-around;
      align-items: center;
      flex-wrap: wrap;
      border: 1px solid rgba(187, 134, 252, 0.2);
    }

    .resumo-item {
      text-align: center;
      padding: 15px;
      flex: 1;
      min-width: 120px;
      transition: transform 0.3s ease;
      border-radius: 8px;
    }

    .resumo-item:hover {
      transform: scale(1.05);
      background-color: rgba(187, 134, 252, 0.1);
    }

    .resumo-item.green {
      color: #03dac6;
      text-shadow: 0 0 10px rgba(3, 218, 198, 0.4);
    }

    .resumo-item.red {
      color: #cf6679;
      text-shadow: 0 0 10px rgba(207, 102, 121, 0.4);
    }

    .resumo-item.gray {
      color: #bb86fc;
      text-shadow: 0 0 10px rgba(187, 134, 252, 0.4);
    }

    .resumo-item strong {
      display: block;
      margin-top: 10px;
      font-size: 20px;
      letter-spacing: 1px;
    }

    /* Gráfico */
    .grafico-container {
      margin-top: 25px;
      padding: 20px;
      background: linear-gradient(145deg, #1e1e2d, #12121e);
      border-radius: 12px;
      box-shadow:
        0 4px 15px rgba(0, 0, 0, 0.5),
        0 0 15px rgba(187, 134, 252, 0.1);
      height: 250px;
      border: 1px solid rgba(187, 134, 252, 0.2);
    }

    /* Loading animation */
    .loading {
      text-align: center;
      padding: 20px;
      color: #bb86fc;
      text-shadow: 0 0 10px rgba(187, 134, 252, 0.5);
      font-size: 16px;
      letter-spacing: 1px;
    }

    .loading::after {
      content: "...";
      animation: dots 1.5s infinite;
    }

    @keyframes dots {

      0%,
      20% {
        content: ".";
      }

      40% {
        content: "..";
      }

      60%,
      100% {
        content: "...";
      }
    }

    /* Status badges */
    .status-badge {
      display: inline-block;
      padding: 5px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
      margin-left: 5px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
    }

    .status-green {
      background-color: rgba(3, 218, 198, 0.2);
      color: #03dac6;
      border: 1px solid #03dac6;
      text-shadow: 0 0 5px rgba(3, 218, 198, 0.5);
      box-shadow: 0 0 10px rgba(3, 218, 198, 0.2);
    }

    .status-red {
      background-color: rgba(207, 102, 121, 0.2);
      color: #cf6679;
      border: 1px solid #cf6679;
      text-shadow: 0 0 5px rgba(207, 102, 121, 0.5);
      box-shadow: 0 0 10px rgba(207, 102, 121, 0.2);
    }

    .status-meio-green {
      background-color: rgba(3, 218, 198, 0.1);
      color: #03dac6;
      border: 1px dashed #03dac6;
      text-shadow: 0 0 5px rgba(3, 218, 198, 0.3);
      box-shadow: 0 0 10px rgba(3, 218, 198, 0.1);
    }

    .status-meio-red {
      background-color: rgba(207, 102, 121, 0.1);
      color: #cf6679;
      border: 1px dashed #cf6679;
      text-shadow: 0 0 5px rgba(207, 102, 121, 0.3);
      box-shadow: 0 0 10px rgba(207, 102, 121, 0.1);
    }

    .status-reembolso {
      background-color: rgba(187, 134, 252, 0.1);
      color: #bb86fc;
      border: 1px dashed #bb86fc;
      text-shadow: 0 0 5px rgba(187, 134, 252, 0.3);
      box-shadow: 0 0 10px rgba(187, 134, 252, 0.1);
    }

    /* Título da seção */
    h3 {
      margin-top: 25px;
      color: #bb86fc;
      text-shadow:
        0 0 10px rgba(187, 134, 252, 0.5),
        0 0 15px rgba(187, 134, 252, 0.3);
      letter-spacing: 1px;
      font-weight: 700;
      text-transform: uppercase;
      font-size: 18px;
    }

    /* Estilo do modal de login */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background: linear-gradient(145deg, #151522, #0c0c14);
      border-radius: 15px;
      box-shadow:
        0 8px 32px rgba(0, 0, 0, 0.7),
        0 0 15px rgba(187, 134, 252, 0.2),
        0 0 30px rgba(187, 134, 252, 0.1);
      padding: 30px;
      width: 100%;
      max-width: 350px;
      border: 1px solid rgba(187, 134, 252, 0.1);
      text-align: center;
      animation: modalFadeIn 0.3s ease;
    }

    @keyframes modalFadeIn {
      from {
        opacity: 0;
        transform: translateY(-50px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .modal h2 {
      color: #bb86fc;
      margin-bottom: 20px;
      text-shadow: 0 0 10px rgba(187, 134, 252, 0.5);
    }

    .modal input {
      margin-bottom: 15px;
    }

    .modal button {
      background: linear-gradient(145deg, #bb86fc, #9c27b0);
      color: #121212;
      border: none;
      border-radius: 8px;
      padding: 12px 20px;
      width: 100%;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 10px;
      box-shadow: 0 0 10px rgba(187, 134, 252, 0.3);
    }

    .modal button:hover {
      background: linear-gradient(145deg, #9c27b0, #bb86fc);
      transform: scale(1.03);
      box-shadow: 0 0 15px rgba(187, 134, 252, 0.5);
    }

    /* Informações do usuário logado */
    .user-info {
      position: absolute;
      top: 15px;
      right: 15px;
      font-size: 14px;
      color: #bb86fc;
      display: flex;
      align-items: center;
    }

    .user-avatar {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: linear-gradient(145deg, #bb86fc, #9c27b0);
      margin-right: 8px;
      display: flex;
      justify-content: center;
      align-items: center;
      font-weight: bold;
      color: #121212;
      box-shadow: 0 0 10px rgba(187, 134, 252, 0.5);
    }

    .user-logout {
      background: none;
      border: none;
      color: #cf6679;
      cursor: pointer;
      margin-left: 8px;
      font-size: 12px;
      opacity: 0.8;
      transition: all 0.3s ease;
    }

    .user-logout:hover {
      opacity: 1;
      text-decoration: underline;
    }
  </style>
</head>

<body>

  <!-- Modal de Login -->
  <div class="modal" id="login-modal">
    <div class="modal-content">
      <h2>Acesso ao Sistema</h2>
      <input type="text" id="username" placeholder="Nome de usuário" />
      <input type="password" id="user-key" placeholder="Chave de acesso" />
      <button id="login-btn">Entrar</button>
    </div>
  </div>

  <div class="container">

    <!-- Botão de Voltar -->
    <button class="back-button" id="voltar-btn"></button>

    <!-- Informações do usuário logado -->
    <div class="user-info" id="user-info">
      <div class="user-avatar" id="user-avatar"></div>
      <span id="user-name"></span>
      <button class="user-logout" id="logout-btn">Sair</button>
    </div>

    <h1>Aposta Moderna</h1>

    <label for="data-hora">Data e Hora da Aposta:</label>
    <input type="text" id="data-hora" readonly />

    <label for="liga">Liga:</label>
    <select id="liga">
      <option value="Battle 6 min">Battle 6 min</option>
      <option value="Battle 8 min">Battle 8 min</option>
      <option value="Battle 8 min (H2H)">Battle 8 min (H2H)</option>
      <option value="Adriact 10 min">Adriact 10 min</option>
      <option value="GT 12 min">GT 12 min</option>
    </select>

    <label for="jogador1">Jogador 1:</label>
    <input type="text" id="jogador1" placeholder="Nome do Jogador 1" />

    <label for="jogador2">Jogador 2:</label>
    <input type="text" id="jogador2" placeholder="Nome do Jogador 2" />

    <label for="mercado">Mercado:</label>
    <select id="mercado">
      <option value="Vitória">Vitória</option>
      <option value="Empate">Empate</option>
      <option value="Handicap +1.5">Handicap +1.5</option>
      <option value="Handicap -1.5">Handicap -1.5</option>
      <option value="Over 2.5">Over 2.5</option>
      <option value="Under 2.5">Under 2.5</option>
      <option value="Ambos marcam">Ambos marcam</option>
      <option value="Não ambos marcam">Não ambos marcam</option>
      <option value="1° Tempo - Vitória">1° Tempo - Vitória</option>
      <option value="2° Tempo - Vitória">2° Tempo - Vitória</option>
      <option value="Escanteios Over 8.5">Escanteios Over 8.5</option>
      <option value="Escanteios Under 8.5">Escanteios Under 8.5</option>
      <option value="Cartões Over 3.5">Cartões Over 3.5</option>
      <option value="Cartões Under 3.5">Cartões Under 3.5</option>
      <option value="Outro">Outro</option>
    </select>

    <!-- Campo adicional para mercado personalizado, exibido apenas quando "Outro" é selecionado -->
    <div id="outro-mercado-container" style="display: none;">
      <label for="outro-mercado">Especifique o mercado:</label>
      <input type="text" id="outro-mercado" placeholder="Digite o mercado personalizado" />
    </div>

    <label for="stake">Stake (R$):</label>
    <input type="text" id="stake" placeholder="Ex: 100,00" />

    <label for="odds">Odds:</label>
    <input type="text" id="odds" placeholder="Ex: 1.65" />

    <label for="resultado">Resultado:</label>
    <select id="resultado">
      <option value="green">Green</option>
      <option value="red">Red</option>
      <option value="meio-green">Meio Green</option>
      <option value="meio-red">Meio Red</option>
      <option value="reembolso">Reembolso</option>
    </select>

    <button id="salvar-dados">Salvar Dados</button>

    <div class="result" id="resultado-final">
      R$ Valor: <span>Calculando...</span>
    </div>

    <!-- Resumo de Ganhos/Perdas -->
    <div class="resumo">
      <div class="resumo-item green" id="ganho-total">
        Ganho Total
        <strong>R$ 0,00</strong>
      </div>
      <div class="resumo-item red" id="perda-total">
        Perda Total
        <strong>R$ 0,00</strong>
      </div>
      <div class="resumo-item gray" id="saldo-total">
        Saldo Total
        <strong>R$ 0,00</strong>
      </div>
    </div>

    <!-- Gráfico de Ganhos/Perdas -->
    <div class="grafico-container" id="grafico">
      <div class="loading">Carregando gráfico</div>
    </div>

    <!-- Lista de Apostas -->
    <h3 style="margin-top: 25px; color: #bb86fc">Histórico de Apostas</h3>
    <div class="apostas-lista" id="apostas-lista">
      <div class="loading">Carregando apostas</div>
    </div>
  </div>

  <!-- Importar Chart.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

  <!-- Importar o SDK do Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      deleteDoc,
      doc,
      onSnapshot,
      serverTimestamp,
      query,
      where,
      orderBy,
      getDocs,
    } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyALiAKWq7Z6B9ut6KCHt9L4g8Vt8VHF6iM",
      authDomain: "rw-tips.firebaseapp.com",
      projectId: "rw-tips",
      storageBucket: "rw-tips.appspot.com",
      messagingSenderId: "806941219354",
      appId: "1:806941219354:web:6f904532b6884251444fa3",
      measurementId: "G-64HF8TWQV4",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Variáveis para gerenciar o usuário atual
    let currentUser = null;
    let currentUserKey = null;

    // Definindo funções no escopo global
    window.removerAposta = async function (id) {
      try {
        await deleteDoc(doc(db, "apostas", id));
        console.log("Aposta removida com sucesso!");
      } catch (error) {
        console.error("Erro ao remover aposta:", error);
        alert("Ocorreu um erro ao remover a aposta: " + error.message);
      }
    };

    window.voltar = function () {
      window.location.href = "visualization.html";
    };

    // Função para formatar valores monetários
    function formatarMoeda(valor) {
      return new Intl.NumberFormat("pt-BR", {
        style: "currency",
        currency: "BRL",
      }).format(valor);
    }

    // Função para verificar se usuário está logado
    function checkUserLogin() {
      currentUser = localStorage.getItem('currentUser');
      currentUserKey = localStorage.getItem('currentUserKey');

      if (!currentUser || !currentUserKey) {
        // Exibir modal de login
        document.getElementById('login-modal').style.display = 'flex';
        return false;
      } else {
        // Atualizar informações do usuário na interface
        document.getElementById('user-name').textContent = currentUser;
        document.getElementById('user-avatar').textContent = currentUser.charAt(0).toUpperCase();
        return true;
      }
    }

    // Função para login
    function login() {
      const username = document.getElementById('username').value.trim();
      const userKey = document.getElementById('user-key').value.trim();

      if (!username || !userKey) {
        alert("Por favor, preencha todos os campos de login.");
        return;
      }

      // Salvar no localStorage
      localStorage.setItem('currentUser', username);
      localStorage.setItem('currentUserKey', userKey);

      // Fechar modal e atualizar interface
      document.getElementById('login-modal').style.display = 'none';
      document.getElementById('user-name').textContent = username;
      document.getElementById('user-avatar').textContent = username.charAt(0).toUpperCase();

      // Atualizar variáveis
      currentUser = username;
      currentUserKey = userKey;

      // Recarregar dados
      carregarApostas();
    }

    // Função para logout
    function logout() {
      localStorage.removeItem('currentUser');
      localStorage.removeItem('currentUserKey');
      currentUser = null;
      currentUserKey = null;

      // Exibir modal de login
      document.getElementById('login-modal').style.display = 'flex';

      // Limpar dados
      document.getElementById('apostas-lista').innerHTML =
        '<div class="loading">Faça login para ver apostas</div>';
      document.getElementById('grafico').innerHTML =
        '<div class="loading">Faça login para ver o gráfico</div>';

      // Resetar resumo
      document.getElementById('ganho-total').querySelector('strong').textContent = 'R$ 0,00';
      document.getElementById('perda-total').querySelector('strong').textContent = 'R$ 0,00';
      document.getElementById('saldo-total').querySelector('strong').textContent = 'R$ 0,00';
    }

    // Atualiza a data e hora atual
    function atualizarDataHora() {
      const agora = new Date();
      document.getElementById("data-hora").value = agora.toLocaleString("pt-BR");
    }

    // Carrega as apostas do usuário atual
    async function carregarApostas() {
      if (!currentUser || !currentUserKey) {
        console.log("Usuário não está logado");
        return;
      }

      const apostasLista = document.getElementById("apostas-lista");
      apostasLista.innerHTML = '<div class="loading">Carregando apostas</div>';

      try {
        // Criar uma consulta filtrada por usuário
        const apostasQuery = query(
          collection(db, "apostas"),
          where("usuario", "==", currentUser),
          where("chaveAcesso", "==", currentUserKey),
          orderBy("dataHora", "desc")
        );

        // Usar onSnapshot para obter atualizações em tempo real
        onSnapshot(apostasQuery, (snapshot) => {
          if (snapshot.empty) {
            apostasLista.innerHTML = '<div style="text-align: center; padding: 15px; color: #bb86fc;">Nenhuma aposta registrada ainda</div>';
            atualizarResumo([]);
            atualizarGrafico([]);
            return;
          }

          let apostasHTML = "";
          const apostasData = [];

          snapshot.forEach((doc) => {
            const aposta = doc.data();
            const id = doc.id;
            apostasData.push({ id, ...aposta });

            // Determinar classe CSS e texto para o status
            let statusClass = "";
            let statusText = "";

            switch (aposta.resultado) {
              case "green":
                statusClass = "status-green";
                statusText = "Green";
                break;
              case "red":
                statusClass = "status-red";
                statusText = "Red";
                break;
              case "meio-green":
                statusClass = "status-meio-green";
                statusText = "Meio Green";
                break;
              case "meio-red":
                statusClass = "status-meio-red";
                statusText = "Meio Red";
                break;
              case "reembolso":
                statusClass = "status-reembolso";
                statusText = "Reembolso";
                break;
            }

            // Calcular valor ganho/perdido
            let valor = 0;
            if (aposta.resultado === "green") {
              valor = aposta.stake * aposta.odds - aposta.stake;
            } else if (aposta.resultado === "red") {
              valor = -aposta.stake;
            } else if (aposta.resultado === "meio-green") {
              valor = (aposta.stake * aposta.odds - aposta.stake) / 2;
            } else if (aposta.resultado === "meio-red") {
              valor = -aposta.stake / 2;
            }

            // Formatar data
            const data = new Date(aposta.dataHora.toDate()).toLocaleString("pt-BR");

            apostasHTML += `
          <div class="aposta-item">
            <div class="aposta-info">
              <strong>${data}</strong> - ${aposta.liga}<br>
              ${aposta.jogador1} vs ${aposta.jogador2}<br>
              ${aposta.mercado} - Stake: R$ ${aposta.stake.toFixed(2)} - Odds: ${aposta.odds.toFixed(2)}
              <span class="${statusClass}">${statusText}</span>
            </div>
            <div class="aposta-actions">
              <button onclick="removerAposta('${id}')">Excluir</button>
            </div>
          </div>
        `;
          });

          apostasLista.innerHTML = apostasHTML;
          atualizarResumo(apostasData);
          atualizarGrafico(apostasData);
        });
      } catch (error) {
        console.error("Erro ao carregar apostas:", error);
        apostasLista.innerHTML = `<div style="text-align: center; padding: 15px; color: #cf6679;">Erro ao carregar apostas: ${error.message}</div>`;
      }
    }

    // Atualiza o resumo financeiro
    function atualizarResumo(apostas) {
      let ganhoTotal = 0;
      let perdaTotal = 0;

      apostas.forEach((aposta) => {
        if (aposta.resultado === "green") {
          ganhoTotal += aposta.stake * aposta.odds - aposta.stake;
        } else if (aposta.resultado === "red") {
          perdaTotal += aposta.stake;
        } else if (aposta.resultado === "meio-green") {
          ganhoTotal += (aposta.stake * aposta.odds - aposta.stake) / 2;
        } else if (aposta.resultado === "meio-red") {
          perdaTotal += aposta.stake / 2;
        }
      });

      const saldoTotal = ganhoTotal - perdaTotal;

      document.getElementById("ganho-total").querySelector("strong").textContent = formatarMoeda(ganhoTotal);
      document.getElementById("perda-total").querySelector("strong").textContent = formatarMoeda(perdaTotal);
      document.getElementById("saldo-total").querySelector("strong").textContent = formatarMoeda(saldoTotal);

      // Definir cor do saldo total
      const saldoElement = document.getElementById("saldo-total");
      if (saldoTotal > 0) {
        saldoElement.className = "resumo-item green";
      } else if (saldoTotal < 0) {
        saldoElement.className = "resumo-item red";
      } else {
        saldoElement.className = "resumo-item gray";
      }
    }

    // Atualiza o gráfico de desempenho
    function atualizarGrafico(apostas) {
      const graficoContainer = document.getElementById("grafico");

      if (apostas.length === 0) {
        graficoContainer.innerHTML = '<div style="text-align: center; padding: 15px; color: #bb86fc;">Sem dados para exibir no gráfico</div>';
        return;
      }

      // Ordenar apostas por data
      apostas.sort((a, b) => a.dataHora.toDate() - b.dataHora.toDate());

      // Preparar dados para o gráfico
      const labels = [];
      const data = [];
      let saldoAcumulado = 0;

      apostas.forEach((aposta, index) => {
        // Calcular valor ganho/perdido
        let valor = 0;
        if (aposta.resultado === "green") {
          valor = aposta.stake * aposta.odds - aposta.stake;
        } else if (aposta.resultado === "red") {
          valor = -aposta.stake;
        } else if (aposta.resultado === "meio-green") {
          valor = (aposta.stake * aposta.odds - aposta.stake) / 2;
        } else if (aposta.resultado === "meio-red") {
          valor = -aposta.stake / 2;
        }

        saldoAcumulado += valor;

        // Adicionar ponto no gráfico
        const data_formatada = new Date(aposta.dataHora.toDate()).toLocaleDateString("pt-BR");
        labels.push(`#${index + 1} (${data_formatada})`);
        data.push(saldoAcumulado);
      });

      // Limpar o container do gráfico
      graficoContainer.innerHTML = '<canvas id="saldo-grafico"></canvas>';

      // Criar gráfico
      const ctx = document.getElementById("saldo-grafico").getContext("2d");

      new Chart(ctx, {
        type: "line",
        data: {
          labels: labels,
          datasets: [
            {
              label: "Saldo Acumulado",
              data: data,
              backgroundColor: "rgba(187, 134, 252, 0.2)",
              borderColor: "#bb86fc",
              borderWidth: 3,
              pointBackgroundColor: function (context) {
                const value = context.dataset.data[context.dataIndex];
                return value >= 0 ? "#03dac6" : "#cf6679";
              },
              pointBorderColor: function (context) {
                const value = context.dataset.data[context.dataIndex];
                return value >= 0 ? "#03dac6" : "#cf6679";
              },
              pointRadius: 5,
              pointHoverRadius: 8,
              fill: true,
              tension: 0.1,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true,
              labels: {
                color: "#e0e0e0"
              }
            },
            tooltip: {
              backgroundColor: "rgba(20, 20, 30, 0.9)",
              titleColor: "#bb86fc",
              bodyColor: "#e0e0e0",
              borderColor: "rgba(187, 134, 252, 0.3)",
              borderWidth: 1,
              callbacks: {
                label: function (context) {
                  return "Saldo: " + formatarMoeda(context.raw);
                }
              }
            }
          },
          scales: {
            x: {
              grid: {
                color: "rgba(255, 255, 255, 0.1)",
              },
              ticks: {
                color: "#e0e0e0",
                maxRotation: 45,
                minRotation: 45
              }
            },
            y: {
              grid: {
                color: "rgba(255, 255, 255, 0.1)",
              },
              ticks: {
                color: "#e0e0e0",
                callback: function (value) {
                  return formatarMoeda(value);
                }
              },
              beginAtZero: false
            }
          }
        }
      });
    }

    // Inicializar a aplicação
    document.addEventListener("DOMContentLoaded", function () {
      // Verificar login
      checkUserLogin();

      // Atualizar data e hora
      atualizarDataHora();
      setInterval(atualizarDataHora, 1000);

      // Carregar apostas (se estiver logado)
      carregarApostas();

      // Atualizar resultado em tempo real
      atualizarResultado();

      // Eventos para botões e campos
      document.getElementById("voltar-btn").addEventListener("click", voltar);
      document.getElementById("logout-btn").addEventListener("click", logout);
      document.getElementById("login-btn").addEventListener("click", login);

      document.getElementById("salvar-dados").addEventListener("click", salvarDados);

      // Adicionar eventos para os campos stake e odds
      document.getElementById("stake").addEventListener("input", atualizarResultado);
      document.getElementById("odds").addEventListener("input", atualizarResultado);
      document.getElementById("resultado").addEventListener("change", atualizarResultado);

      // Adicionar evento para o campo mercado
      document.getElementById("mercado").addEventListener("change", function () {
        const mercado = document.getElementById("mercado").value;
        const outroMercadoContainer = document.getElementById("outro-mercado-container");

        if (mercado === "Outro") {
          outroMercadoContainer.style.display = "block";
        } else {
          outroMercadoContainer.style.display = "none";
        }

        atualizarResultado();
      });

      // Adicionar mercados personalizados (pode ser carregado do Firebase também)
      carregarMercadosPersonalizados();
    });

    // Carrega mercados personalizados do Firebase
    async function carregarMercadosPersonalizados() {
      if (!currentUser || !currentUserKey) return;

      try {
        const mercadosQuery = query(
          collection(db, "mercados_personalizados"),
          where("usuario", "==", currentUser)
        );

        const snapshot = await getDocs(mercadosQuery);

        if (!snapshot.empty) {
          const selectMercado = document.getElementById("mercado");
          const outroOption = selectMercado.querySelector('option[value="Outro"]');

          // Remover opção "Outro" temporariamente
          if (outroOption) {
            selectMercado.removeChild(outroOption);
          }

          // Adicionar mercados personalizados
          snapshot.forEach((doc) => {
            const mercado = doc.data();
            const option = document.createElement("option");
            option.value = mercado.nome;
            option.textContent = mercado.nome;
            selectMercado.appendChild(option);
          });

          // Readicionar opção "Outro"
          if (outroOption) {
            selectMercado.appendChild(outroOption);
          }
        }
      } catch (error) {
        console.error("Erro ao carregar mercados personalizados:", error);
      }
    }

    // Salva um novo mercado personalizado
    async function salvarMercadoPersonalizado(nomeMercado) {
      if (!currentUser || !currentUserKey || !nomeMercado) return;

      try {
        // Verificar se o mercado já existe
        const mercadosQuery = query(
          collection(db, "mercados_personalizados"),
          where("usuario", "==", currentUser),
          where("nome", "==", nomeMercado)
        );

        const snapshot = await getDocs(mercadosQuery);

        if (snapshot.empty) {
          // Adicionar novo mercado
          await addDoc(collection(db, "mercados_personalizados"), {
            usuario: currentUser,
            nome: nomeMercado,
            timestamp: serverTimestamp()
          });

          console.log("Mercado personalizado salvo com sucesso!");

          // Recarregar mercados
          carregarMercadosPersonalizados();
        }
      } catch (error) {
        console.error("Erro ao salvar mercado personalizado:", error);
      }
    }

    // Função para atualizar o resultado em tempo real
    function atualizarResultado() {
      const stake = parseFloat(document.getElementById("stake").value.replace(",", ".")) || 0;
      const odds = parseFloat(document.getElementById("odds").value.replace(",", ".")) || 0;
      const resultado = document.getElementById("resultado").value;

      let valor = 0;

      if (resultado === "green") {
        valor = stake * odds - stake;
      } else if (resultado === "red") {
        valor = -stake;
      } else if (resultado === "meio-green") {
        valor = (stake * odds - stake) / 2;
      } else if (resultado === "meio-red") {
        valor = -stake / 2;
      }

      document.getElementById("resultado-final").querySelector("span").textContent = formatarMoeda(valor);

      // Mudar cor do resultado
      const resultadoElement = document.getElementById("resultado-final");

      if (valor > 0) {
        resultadoElement.style.color = "#03dac6";
        resultadoElement.style.textShadow = "0 0 10px rgba(3, 218, 198, 0.4)";
      } else if (valor < 0) {
        resultadoElement.style.color = "#cf6679";
        resultadoElement.style.textShadow = "0 0 10px rgba(207, 102, 121, 0.4)";
      } else {
        resultadoElement.style.color = "#bb86fc";
        resultadoElement.style.textShadow = "0 0 10px rgba(187, 134, 252, 0.4)";
      }
    }

    // Função para salvar os dados da aposta
    async function salvarDados() {
      if (!currentUser || !currentUserKey) {
        alert("Você precisa estar logado para salvar apostas.");
        document.getElementById('login-modal').style.display = 'flex';
        return;
      }

      const dataHora = new Date(document.getElementById("data-hora").value.replace(",", "."));
      const liga = document.getElementById("liga").value;
      const jogador1 = document.getElementById("jogador1").value.trim();
      const jogador2 = document.getElementById("jogador2").value.trim();

      // Determinar mercado (padrão ou personalizado)
      let mercado = document.getElementById("mercado").value;
      if (mercado === "Outro") {
        mercado = document.getElementById("outro-mercado").value.trim();

        // Verificar se devemos salvar o mercado personalizado
        if (mercado && confirm("Deseja salvar este mercado personalizado para uso futuro?")) {
          salvarMercadoPersonalizado(mercado);
        }
      }

      const stake = parseFloat(document.getElementById("stake").value.replace(",", ".")) || 0;
      const odds = parseFloat(document.getElementById("odds").value.replace(",", ".")) || 0;
      const resultado = document.getElementById("resultado").value;

      // Validação
      if (!liga || !jogador1 || !jogador2 || !mercado || stake <= 0 || odds <= 0) {
        alert("Por favor, preencha todos os campos corretamente.");
        return;
      }

      try {
        const docRef = await addDoc(collection(db, "apostas"), {
          usuario: currentUser,
          chaveAcesso: currentUserKey,
          dataHora: dataHora,
          liga: liga,
          jogador1: jogador1,
          jogador2: jogador2,
          mercado: mercado,
          stake: stake,
          odds: odds,
          resultado: resultado,
          timestamp: serverTimestamp()
        });

        console.log("Aposta salva com sucesso!");

        // Limpar campos
        document.getElementById("jogador1").value = "";
        document.getElementById("jogador2").value = "";
        document.getElementById("stake").value = "";
        document.getElementById("odds").value = "";
        document.getElementById("mercado").selectedIndex = 0;
        document.getElementById("resultado").selectedIndex = 0;
        document.getElementById("outro-mercado").value = "";
        document.getElementById("outro-mercado-container").style.display = "none";

        // Atualizar resultado
        atualizarResultado();
      } catch (error) {
        console.error("Erro ao salvar aposta:", error);
        alert("Ocorreu um erro ao salvar a aposta: " + error.message);
      }
    }

    // Event listeners
    document
      .getElementById("voltar-btn")
      .addEventListener("click", window.voltar);
    document.getElementById("stake").addEventListener("input", calcularValor);
    document.getElementById("odds").addEventListener("input", calcularValor);
    document
      .getElementById("resultado")
      .addEventListener("change", calcularValor);

    let jogadoresCache = {};

    // Função para buscar dados da API
    async function buscarDadosAPI() {
      try {
        const response = await fetch('https://api.green365.com.br/api/events/ended?sport_id=4&competition_id=&page=1');
        const data = await response.json();

        if (data && data.data) {
          // Processa os dados e agrupa por liga
          const jogadoresPorLiga = {};

          data.data.forEach(match => {
            const ligaNome = match.leagueName;
            const liga = mapearLiga(ligaNome);

            if (!jogadoresPorLiga[liga]) {
              jogadoresPorLiga[liga] = new Set();
            }

            // Extrai nomes de jogadores do formato "Time (Jogador)"
            if (match.home) {
              const homePlayer = extrairNomeJogador(match.home);
              if (homePlayer) jogadoresPorLiga[liga].add(homePlayer);
            }

            if (match.away) {
              const awayPlayer = extrairNomeJogador(match.away);
              if (awayPlayer) jogadoresPorLiga[liga].add(awayPlayer);
            }
          });

          // Converte Sets para Arrays ordenados alfabeticamente
          for (const liga in jogadoresPorLiga) {
            jogadoresCache[liga] = Array.from(jogadoresPorLiga[liga]).sort();
          }

          // Atualiza os datalists depois de carregar
          atualizarDatalistsJogadores();
        }
      } catch (error) {
        console.error("Erro ao buscar dados da API:", error);
      }
    }

    // Função para mapear o nome da liga da API para as opções do select
    function mapearLiga(ligaNome) {
      if (ligaNome.includes("6 mins")) return "Battle 6 min";
      if (ligaNome.includes("8 mins") && ligaNome.includes("H2H")) return "Battle 8 min (H2H)";
      if (ligaNome.includes("8 mins")) return "Battle 8 min";
      if (ligaNome.includes("10 mins")) return "Adriact 10 min";
      if (ligaNome.includes("12 mins")) return "GT 12 min";
      return "Outro";
    }

    // Função para extrair nome do jogador de uma string "Time (Jogador)"
    function extrairNomeJogador(texto) {
      const match = texto.match(/\(([^)]+)\)/);
      return match ? match[1] : null;
    }

    // Função para atualizar as listas de jogadores baseado na liga selecionada
    function atualizarDatalistsJogadores() {
      const ligaSelecionada = document.getElementById("liga").value;
      const jogadoresDatalist = document.getElementById("jogadores-lista");

      if (!jogadoresDatalist) {
        // Criar os datalists se não existirem
        const dataList = document.createElement("datalist");
        dataList.id = "jogadores-lista";
        document.body.appendChild(dataList);
      } else {
        // Limpar datalist existente
        jogadoresDatalist.innerHTML = "";
      }

      // Preencher o datalist com jogadores da liga selecionada
      if (jogadoresCache[ligaSelecionada]) {
        jogadoresCache[ligaSelecionada].forEach(jogador => {
          const option = document.createElement("option");
          option.value = jogador;
          jogadoresDatalist.appendChild(option);
        });
      }
    }

    // Adicionar lista de dados aos inputs
    function configurarCamposJogadores() {
      // Adicionar datalist para jogadores
      if (!document.getElementById("jogadores-lista")) {
        const dataList = document.createElement("datalist");
        dataList.id = "jogadores-lista";
        document.body.appendChild(dataList);
      }

      // Conectar inputs aos datalists
      const jogador1Input = document.getElementById("jogador1");
      const jogador2Input = document.getElementById("jogador2");

      jogador1Input.setAttribute("list", "jogadores-lista");
      jogador2Input.setAttribute("list", "jogadores-lista");

      // Atualizar jogadores quando mudar a liga
      document.getElementById("liga").addEventListener("change", atualizarDatalistsJogadores);
    }

    // Modificar o window.onload para incluir as novas funções
    window.onload = () => {
      atualizarDataHora();
      calcularValor();
      carregarApostas();
      configurarCamposJogadores();
      buscarDadosAPI();
    };

  </script>
</body>

</html>