<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Formulário de Apostas</title>
  <style>
    :root {
      --neon-primary: #0ff;
      --neon-secondary: #f0f;
      --dark-bg: #1a1a1a;
      --darker-bg: #121212;
      --light-text: #e0e0e0;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', sans-serif;
    }

    body {
      background-color: var(--dark-bg);
      color: var(--light-text);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background-color: var(--darker-bg);
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(0, 255, 255, 0.2);
    }

    h1 {
      color: var(--neon-primary);
      text-align: center;
      margin-bottom: 30px;
      text-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      color: var(--neon-primary);
    }

    input,
    select {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--neon-primary);
      background-color: rgba(0, 255, 255, 0.1);
      color: var(--light-text);
      border-radius: 5px;
    }

    input:focus,
    select:focus {
      outline: none;
      box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
    }

    button {
      background-color: var(--neon-primary);
      color: var(--darker-bg);
      border: none;
      padding: 12px 24px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s ease;
      margin: 10px 0;
    }

    button:hover {
      background-color: #00cccc;
      box-shadow: 0 0 15px rgba(0, 255, 255, 0.5);
    }

    .result {
      margin: 20px 0;
      padding: 15px;
      background-color: rgba(0, 255, 255, 0.1);
      border-radius: 5px;
      text-align: center;
    }

    .resumo {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin: 20px 0;
    }

    .resumo-item {
      padding: 15px;
      background-color: rgba(0, 255, 255, 0.1);
      border-radius: 5px;
      text-align: center;
    }

    .resumo-item strong {
      display: block;
      margin-top: 5px;
      font-size: 1.2em;
    }

    .green {
      color: #00ff00;
    }

    .red {
      color: #ff0000;
    }

    .gray {
      color: #888888;
    }

    .grafico-container {
      height: 300px;
      margin: 20px 0;
      padding: 15px;
      background-color: rgba(0, 255, 255, 0.1);
      border-radius: 5px;
    }

    .apostas-lista {
      margin-top: 20px;
    }

    .aposta-item {
      background-color: rgba(0, 255, 255, 0.1);
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 5px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .aposta-info {
      flex-grow: 1;
    }

    .aposta-actions button {
      background-color: #ff4444;
      padding: 8px 16px;
      font-size: 0.9em;
    }

    .aposta-actions button:hover {
      background-color: #cc0000;
    }

    .loading {
      text-align: center;
      padding: 20px;
      color: var(--neon-primary);
    }

    @media (max-width: 600px) {
      .container {
        padding: 10px;
      }

      .resumo {
        grid-template-columns: 1fr;
      }

      .aposta-item {
        flex-direction: column;
      }

      .aposta-actions {
        margin-top: 10px;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <button id="voltar-btn" style="margin-bottom: 20px;">Voltar</button>
    <h1>Registro de Apostas</h1>

    <div class="form-group">
      <label for="data-hora">Data e Hora</label>
      <input type="text" id="data-hora" readonly>
    </div>

    <div class="form-group">
      <label for="liga">Liga</label>
      <select id="liga" required>
        <option value="">Selecione a liga</option>
        <option value="Esoccer Battle - 8 mins play">Esoccer Battle - 8 mins play</option>
        <option value="Esoccer Battle Volta - 6 mins play">Esoccer Battle Volta - 6 mins play</option>
        <option value="Esoccer GT Leagues – 12 mins play">Esoccer GT Leagues – 12 mins play</option>
        <option value="Esoccer H2H GG League - 8 mins play">Esoccer H2H GG League - 8 mins play</option>
        <option value="Esoccer Adriatic League - 10 mins play">Esoccer Adriatic League - 10 mins play</option>
      </select>
    </div>

    <div class="form-group">
      <label for="jogador1">Jogador 1</label>
      <select id="jogador1" required></select>
    </div>

    <div class="form-group">
      <label for="jogador2">Jogador 2</label>
      <select id="jogador2" required></select>
    </div>

    <div class="form-group">
      <label for="mercado">Mercado</label>
      <select id="mercado">
        <option value="Vitória">Vitória</option>
        <option value="Over 1.5">Over 1.5</option>
        <option value="Over 2.5">Over 2.5</option>
        <option value="Over 3.5">Over 3.5</option>
        <option value="Ambas Marcam">Ambas Marcam</option>
      </select>
    </div>

    <div class="form-group">
      <label for="stake">Stake (R$)</label>
      <input type="text" id="stake" required placeholder="0,00">
    </div>

    <div class="form-group">
      <label for="odds">Odds</label>
      <input type="text" id="odds" required placeholder="1.50">
    </div>

    <div class="form-group">
      <label for="resultado">Resultado</label>
      <select id="resultado">
        <option value="green">Green</option>
        <option value="red">Red</option>
        <option value="meio-green">Meio Green</option>
        <option value="meio-red">Meio Red</option>
        <option value="reembolso">Reembolso</option>
      </select>
    </div>

    <button id="salvar-dados">Salvar Dados</button>

    <div class="result" id="resultado-final">
      R$ Valor: <span>Calculando...</span>
    </div>

    <div class="resumo">
      <div class="resumo-item green" id="ganho-total">
        Ganho Total
        <strong>R$ 0,00</strong>
      </div>
      <div class="resumo-item red" id="perda-total">
        Perda Total
        <strong>R$ 0,00</strong>
      </div>
      <div class="resumo-item" id="saldo-total">
        Saldo Total
        <strong>R$ 0,00</strong>
      </div>
    </div>

    <div class="grafico-container" id="grafico">
      <div class="loading">Carregando gráfico</div>
    </div>

    <h3 style="margin-top: 25px; color: var(--neon-primary)">Histórico de Apostas</h3>
    <div class="apostas-lista" id="apostas-lista">
      <div class="loading">Carregando apostas</div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      deleteDoc,
      doc,
      onSnapshot,
      serverTimestamp,
      query,
      where,
      orderBy,
      getDocs,
    } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyALiAKWq7Z6B9ut6KCHt9L4g8Vt8VHF6iM",
      authDomain: "rw-tips.firebaseapp.com",
      projectId: "rw-tips",
      storageBucket: "rw-tips.appspot.com",
      messagingSenderId: "806941219354",
      appId: "1:806941219354:web:6f904532b6884251444fa3",
      measurementId: "G-64HF8TWQV4",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Funções auxiliares
    function formatarMoeda(valor) {
      return valor.toLocaleString('pt-BR', {
        style: 'currency',
        currency: 'BRL'
      });
    }

    function getStatusClass(resultado) {
      const classes = {
        'green': 'green',
        'red': 'red',
        'meio-green': 'green',
        'meio-red': 'red',
        'reembolso': 'gray'
      };
      return classes[resultado] || '';
    }

    function getStatusText(resultado) {
      const textos = {
        'green': 'Green',
        'red': 'Red',
        'meio-green': 'Meio Green',
        'meio-red': 'Meio Red',
        'reembolso': 'Reembolso'
      };
      return textos[resultado] || resultado;
    }

    // Função para buscar jogadores
    async function buscarJogadores() {
      const liga = document.getElementById("liga").value;
      const jogador1El = document.getElementById("jogador1");
      const jogador2El = document.getElementById("jogador2");

      jogador1El.innerHTML = '<option value="">Selecione o jogador 1</option>';
      jogador2El.innerHTML = '<option value="">Selecione o jogador 2</option>';

      if (!liga) return;

      try {
        const jogadoresRef = collection(db, "jogadores");
        const q = query(jogadoresRef, where("liga", "==", liga));
        const querySnapshot = await getDocs(q);

        const jogadores = [];
        querySnapshot.forEach((doc) => {
          jogadores.push(doc.data().nome);
        });

        jogadores.sort();

        jogadores.forEach(jogador => {
          jogador1El.innerHTML += `<option value="${jogador}">${jogador}</option>`;
          jogador2El.innerHTML += `<option value="${jogador}">${jogador}</option>`;
        });
      } catch (error) {
        console.error("Erro ao buscar jogadores:", error);
        alert("Erro ao carregar jogadores. Por favor, tente novamente.");
      }
    }

    // Função para calcular valor
    function calcularValor() {
      const stake = parseFloat(document.getElementById("stake").value.replace(/[^\d.,]/g, "").replace(",", "."));
      const odds = parseFloat(document.getElementById("odds").value.replace(",", "."));
      const resultado = document.getElementById("resultado").value;

      let valorFinal = 0;

      if (isNaN(stake) || isNaN(odds)) {
        document.getElementById("resultado-final").innerHTML = `R$ Valor: <span>Valores inválidos</span>`;
        return;
      }

      switch (resultado) {
        case "green":
          valorFinal = stake * (odds - 1);
          break;
        case "red":
          valorFinal = -stake;
          break;
        case "meio-green":
          valorFinal = (stake / 2) * (odds - 1);
          break;
        case "meio-red":
          valorFinal = -stake / 2;
          break;
        case "reembolso":
          valorFinal = 0;
          break;
      }

      document.getElementById("resultado-final").innerHTML = `R$ Valor: <span>${formatarMoeda(valorFinal)}</span>`;
    }

    // Função para atualizar data e hora
    function atualizarDataHora() {
      const agora = new Date();
      const options = { dateStyle: "short", timeStyle: "medium" };
      document.getElementById("data-hora").value = agora.toLocaleString("pt-BR", options);
    }

    // Função para limpar campos
    function limparCampos() {
      document.getElementById("jogador1").value = "";
      document.getElementById("jogador2").value = "";
      document.getElementById("mercado").value = "";
      document.getElementById("stake").value = "";
      document.getElementById("odds").value = "";
      document.getElementById("resultado").value = "green";
      atualizarDataHora();
      calcularValor();
    }

    // Função para criar gráfico
    async function criarGrafico() {
      try {
        const graficoContainer = document.getElementById("grafico");
        if (!graficoContainer) return;

        let canvas = graficoContainer.querySelector('canvas');
        if (!canvas) {
          canvas = document.createElement('canvas');
          graficoContainer.innerHTML = '';
          graficoContainer.appendChild(canvas);
        }

        const datas = [];
        for (let i = 6; i >= 0; i--) {
          const data = new Date();
          data.setDate(data.getDate() - i);
          datas.push(data);
        }

        const apostasQuery = query(collection(db, "apostas"), orderBy("timestamp", "asc"));
        const snapshot = await getDocs(apostasQuery);
        const todasApostas = [];

        snapshot.forEach((doc) => {
          const data = doc.data();
          todasApostas.push({
            ...data,
            id: doc.id,
            timestamp: data.timestamp?.toDate() || new Date(),
          });
        });

        const saldosDiarios = datas.map((data) => {
          const dataStr = data.toLocaleDateString("pt-BR");
          const inicioDoDia = new Date(data);
          inicioDoDia.setHours(0, 0, 0, 0);
          const fimDoDia = new Date(data);
          fimDoDia.setHours(23, 59, 59, 999);

          const apostasDoDia = todasApostas.filter((aposta) => {
            return aposta.timestamp >= inicioDoDia && aposta.timestamp <= fimDoDia;
          });

          let saldoDia = 0;
          apostasDoDia.forEach((aposta) => {
            const stake = parseFloat(
              aposta.stake.replace(/[^\d.,]/g, "").replace(",", ".")
            );
            const odds = parseFloat(aposta.odds.replace(",", "."));

            switch (aposta.resultado) {
              case "green":
                saldoDia += stake * (odds - 1);
                break;
              case "red":
                saldoDia -= stake;
                break;
              case "meio-green":
                saldoDia += (stake / 2) * (odds - 1);
                break;
              case "meio-red":
                saldoDia -= stake / 2;
                break;
            }
          });

          return {
            data: dataStr,
            saldo: Number(saldoDia.toFixed(2))
          };
        });

        if (window.myChart) {
          window.myChart.destroy();
        }

        window.myChart = new Chart(canvas, {
          type: "line",
          data: {
            labels: saldosDiarios.map((item) => item.data),
            datasets: [
              {
                label: "Saldo Diário",
                data: saldosDiarios.map((item) => item.saldo),
                borderColor: "#0ff",
                backgroundColor: "rgba(0, 255, 255, 0.1)",
                tension: 0.4,
                fill: true,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                labels: {
                  color: "#e0e0e0",
                  font: {
                    family: "'Segoe UI', sans-serif"
                  }
                }
              },
              tooltip: {
                backgroundColor: "rgba(0, 0, 0, 0.8)",
                titleColor: "#0ff",
                bodyColor: "#fff",
                borderColor: "#0ff",
                borderWidth: 1,
                padding: 10,
                displayColors: false,
                callbacks: {
                  label: function (context) {
                    return `Saldo: ${formatarMoeda(context.raw)}`;
                  }
                }
              }
            },
            scales: {
              y: {
                grid: {
                  color: "rgba(255, 255, 255, 0.1)",
                },
                ticks: {
                  color: "#e0e0e0",
                  callback: function (value) {
                    return formatarMoeda(value);
                  }
                }
              },
              x: {
                grid: {
                  color: "rgba(255, 255, 255, 0.1)",
                },
                ticks: {
                  color: "#e0e0e0",
                }
              }
            }
          }
        });
      } catch (error) {
        console.error("Erro ao criar gráfico:", error);
        document.getElementById("grafico").innerHTML = '<div style="text-align: center; padding: 15px; color: #888;">Erro ao carregar o gráfico</div>';
      }
    }

    // Função para carregar apostas
    function carregarApostas() {
      const apostasLista = document.getElementById("apostas-lista");
      apostasLista.innerHTML = '<div class="loading">Carregando apostas</div>';

      const hoje = new Date();
      const inicioDoDia = new Date(hoje.setHours(0, 0, 0, 0));
      const fimDoDia = new Date(hoje.setHours(23, 59, 59, 999));

      const apostasRef = query(
        collection(db, "apostas"),
        where("timestamp", ">", inicioDoDia),
        where("timestamp", "<", fimDoDia),
        orderBy("timestamp", "desc")
      );

      onSnapshot(apostasRef, (snapshot) => {
        let ganhoTotal = 0;
        let perdaTotal = 0;
        let todasApostas = [];

        if (snapshot.empty) {
          apostasLista.innerHTML = '<div style="text-align: center; padding: 15px; color: #888;">Nenhuma aposta registrada hoje</div>';
          document.getElementById("grafico").innerHTML = '<div style="text-align: center; padding: 15px; color: #888;">Sem dados para exibir</div>';
          return;
        }

        apostasLista.innerHTML = "";

        snapshot.forEach((doc) => {
          const aposta = doc.data();
          todasApostas.push({ ...aposta, id: doc.id });

          const stake = parseFloat(aposta.stake.replace(/[^\d.,]/g, "").replace(",", "."));
          const odds = parseFloat(aposta.odds.replace(",", "."));
          let valorFinal = 0;

          switch (aposta.resultado) {
            case "green":
              valorFinal = stake * (odds - 1);
              ganhoTotal += valorFinal;
              break;
            case "red":
              valorFinal = -stake;
              perdaTotal += stake;
              break;
            case "meio-green":
              valorFinal = (stake / 2) * (odds - 1);
              ganhoTotal += valorFinal;
              break;
            case "meio-red":
              valorFinal = -stake / 2;
              perdaTotal += stake / 2;
              break;
          }

          const statusClass = getStatusClass(aposta.resultado);
          const statusText = getStatusText(aposta.resultado);
          const valorFinalText = valorFinal === 0 ? "" : ` (${formatarMoeda(valorFinal)})`;

          const apostaItem = document.createElement("div");
          apostaItem.classList.add("aposta-item");
          apostaItem.innerHTML = `
                        <div class="aposta-info">
                            <strong>${aposta.liga}</strong> · <span class="${statusClass}">${statusText}${valorFinalText}</span><br>
                            ${aposta.jogador1} vs ${aposta.jogador2}<br>
                            <small>${aposta.mercado} · Stake: ${aposta.stake} · Odds: ${aposta.odds}</small>
                        </div>
                        <div class="aposta-actions">
                            <button onclick="removerAposta('${doc.id}')">Remover</button>
                        </div>
                    `;
          apostasLista.appendChild(apostaItem);
        });

        document.getElementById("ganho-total").innerHTML = `Ganho Total<strong>${formatarMoeda(ganhoTotal)}</strong>`;
        document.getElementById("perda-total").innerHTML = `Perda Total<strong>${formatarMoeda(perdaTotal)}</strong>`;
        document.getElementById("saldo-total").innerHTML = `Saldo Total<strong>${formatarMoeda(ganhoTotal - perdaTotal)}</strong>`;

        criarGrafico();
      });
    }

    // Event Listeners
    document.getElementById("liga").addEventListener("change", buscarJogadores);
    document.getElementById("stake").addEventListener("input", calcularValor);
    document.getElementById("odds").addEventListener("input", calcularValor);
    document.getElementById("resultado").addEventListener("change", calcularValor);
    document.getElementById("voltar-btn").addEventListener("click", () => window.location.href = "visualization.html");

    document.getElementById("salvar-dados").addEventListener("click", async () => {
      const dataHora = document.getElementById("data-hora").value;
      const liga = document.getElementById("liga").value;
      const jogador1 = document.getElementById("jogador1").value;
      const jogador2 = document.getElementById("jogador2").value;
      const mercado = document.getElementById("mercado").value;
      const stake = document.getElementById("stake").value;
      const odds = document.getElementById("odds").value;
      const resultado = document.getElementById("resultado").value;

      if (!jogador1 || !jogador2 || !stake || !odds) {
        alert("Preencha todos os campos obrigatórios!");
        return;
      }

      try {
        await addDoc(collection(db, "apostas"), {
          dataHora,
          liga,
          jogador1,
          jogador2,
          mercado: mercado || "Vitória",
          stake: stake.includes("R$") ? stake : `R$ ${stake}`,
          odds,
          resultado,
          timestamp: serverTimestamp(),
        });
        alert("Aposta registrada com sucesso!");
        limparCampos();
      } catch (error) {
        console.error("Erro ao salvar os dados: ", error);
        alert("Ocorreu um erro ao salvar os dados: " + error.message);
      }
    });

    // Função global para remover aposta
    window.removerAposta = async function (id) {
      try {
        await deleteDoc(doc(db, "apostas", id));
        console.log("Aposta removida com sucesso!");
      } catch (error) {
        console.error("Erro ao remover aposta:", error);
        alert("Ocorreu um erro ao remover a aposta: " + error.message);
      }
    };

    // Inicialização
    window.onload = () => {
      atualizarDataHora();
      calcularValor();
      carregarApostas();
      buscarJogadores();
    };
  </script>
</body>

</html>
